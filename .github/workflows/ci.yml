name: CI/CD Pipeline

on:
  push:
    branches: [ main, development ]
  pull_request:
    branches: [ main ]

env:
  SCHEME: PokedexPocket
  CONFIGURATION: Debug

jobs:
  test-swift:
    name: Swift Tests
    runs-on: macos-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Cache SPM dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData/*/SourcePackages
          .build
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-
          
    - name: Install SwiftLint
      run: |
        if ! which swiftlint >/dev/null; then
          brew install swiftlint
        fi
        
    - name: Run SwiftLint
      run: |
        swiftlint lint --quiet
        
    - name: Resolve Package Dependencies
      run: |
        xcodebuild -resolvePackageDependencies -scheme $SCHEME -quiet
        
    - name: Boot iOS Simulator
      run: |
        # Find iPhone 16 Pro first, then fallback to any iPhone
        SIMULATOR_LINE=$(xcrun simctl list devices | grep -A 20 "iOS 18\." | grep "iPhone 16 Pro" | head -1)
        if [ -z "$SIMULATOR_LINE" ]; then
          echo "iPhone 16 Pro not found, trying any iPhone"
          SIMULATOR_LINE=$(xcrun simctl list devices | grep -A 20 "iOS 18\." | grep "iPhone" | head -1)
        fi
        
        if [ -n "$SIMULATOR_LINE" ]; then
          SIMULATOR_ID=$(echo "$SIMULATOR_LINE" | sed -n 's/.*(\([^)]*\)).*/\1/p')
          SIMULATOR_NAME=$(echo "$SIMULATOR_LINE" | sed -n 's/[[:space:]]*\([^(]*\).*/\1/p' | xargs)
          echo "Found simulator: $SIMULATOR_NAME ($SIMULATOR_ID)"
          xcrun simctl boot "$SIMULATOR_ID"
          echo "SIMULATOR_ID=$SIMULATOR_ID" >> $GITHUB_ENV
        else
          echo "No suitable simulator found"
          exit 1
        fi
        
    - name: Build and Test
      run: |
        echo "ðŸ”¨ Building and testing with simulator: $SIMULATOR_ID"
        set -o pipefail && xcodebuild \
          -scheme $SCHEME \
          -destination "platform=iOS Simulator,id=$SIMULATOR_ID" \
          -configuration $CONFIGURATION \
          -quiet \
          test \
          -only-testing:PokedexPocketTests \
          | xcpretty
          
    - name: Test Summary
      if: always()
      run: |
        if [ $? -eq 0 ]; then
          echo "âœ… All tests passed!"
        else
          echo "âŒ Some tests failed"
          exit 1
        fi

  lint-only:
    name: Code Quality
    runs-on: macos-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install SwiftLint
      run: |
        if ! which swiftlint >/dev/null; then
          brew install swiftlint
        fi
        
    - name: Run SwiftLint (Strict)
      run: |
        echo "ðŸ” Running SwiftLint analysis..."
        swiftlint lint --strict
        echo "âœ… Code quality check passed!"

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [test-swift, lint-only]
    if: github.event_name == 'pull_request'
    
    steps:
    - name: PR Status
      run: |
        echo "## ðŸŽ‰ PR Checks Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Swift Tests**: Passed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Code Quality**: Passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All checks completed successfully! ðŸš€" >> $GITHUB_STEP_SUMMARY